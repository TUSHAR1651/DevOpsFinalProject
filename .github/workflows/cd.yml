name: CD Pipeline - Deploy to Kubernetes
# Continuous Deployment workflow for Kubernetes

on:
  workflow_run:
    workflows: ["Java CI Pipeline"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    # Only run if CI workflow succeeded (or manual trigger)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        run: |
          echo "ğŸ”§ Configuring kubectl..."
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          export KUBECONFIG=~/.kube/config

      - name: Verify cluster connection
        run: |
          echo "ğŸ” Verifying Kubernetes cluster connection..."
          if ! kubectl cluster-info &> /dev/null; then
            echo "âŒ Failed to connect to Kubernetes cluster"
            echo "Please verify that:"
            echo "  1. KUBE_CONFIG secret is correctly configured"
            echo "  2. The cluster is accessible and running"
            echo "  3. The kubeconfig has valid credentials"
            exit 1
          fi
          echo "âœ… Successfully connected to Kubernetes cluster"
          kubectl cluster-info
          kubectl version --short

      - name: Verify cluster nodes
        run: |
          echo "ğŸ–¥ï¸  Checking cluster nodes..."
          if ! kubectl get nodes &> /dev/null; then
            echo "âŒ Failed to get cluster nodes"
            exit 1
          fi
          echo "âœ… Cluster nodes are healthy"
          kubectl get nodes

      - name: Create namespace if not exists
        run: |
          echo "ğŸ“¦ Ensuring namespace exists..."
          kubectl create namespace devops-demo --dry-run=client -o yaml | kubectl apply -f -

      - name: Create Docker Hub secret
        run: |
          echo "ğŸ” Creating/updating Docker Hub registry secret..."
          kubectl create secret docker-registry dockerhub-secret \
            --docker-server=https://index.docker.io/v1/ \
            --docker-username=${{ secrets.DOCKERHUB_USERNAME }} \
            --docker-password=${{ secrets.DOCKERHUB_TOKEN }} \
            --namespace=devops-demo \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Prepare deployment manifests
        run: |
          echo "ğŸ“ Preparing deployment manifests..."
          # Replace DOCKERHUB_USERNAME placeholder in deployment
          sed -i "s/\${DOCKERHUB_USERNAME}/${{ secrets.DOCKERHUB_USERNAME }}/g" k8s/deployment.yaml

          # Show what will be deployed
          echo "ğŸ“‹ Deployment manifest:"
          cat k8s/deployment.yaml

      - name: Apply ConfigMap
        run: |
          echo "âš™ï¸  Applying ConfigMap..."
          kubectl apply -f k8s/configmap.yaml -n devops-demo
          kubectl get configmap -n devops-demo

      - name: Apply Secret
        run: |
          echo "ğŸ”’ Applying application secrets..."
          kubectl apply -f k8s/secret.yaml -n devops-demo

      - name: Apply Service
        run: |
          echo "ğŸŒ Applying Service..."
          kubectl apply -f k8s/service.yaml -n devops-demo
          kubectl get svc -n devops-demo

      - name: Deploy application
        run: |
          echo "ğŸš€ Deploying application to Kubernetes..."
          kubectl apply -f k8s/deployment.yaml -n devops-demo

          echo "ğŸ“Š Deployment status:"
          kubectl get deployment devops-demo -n devops-demo

      - name: Wait for deployment rollout
        run: |
          echo "â³ Waiting for deployment to complete (timeout: 5 minutes)..."
          if kubectl rollout status deployment/devops-demo -n devops-demo --timeout=5m; then
            echo "âœ… Deployment completed successfully!"
          else
            echo "âŒ Deployment rollout failed or timed out"
            echo "ğŸ“‹ Pod status:"
            kubectl get pods -n devops-demo
            echo "ğŸ“‹ Recent pod events:"
            kubectl get events -n devops-demo --sort-by='.lastTimestamp' | tail -20
            exit 1
          fi

      - name: Verify deployment health
        run: |
          echo "ğŸ¥ Checking deployment health..."

          # Check pod status
          echo "ğŸ“‹ Pod status:"
          kubectl get pods -n devops-demo -l app=devops-demo

          # Check if pods are ready
          READY_PODS=$(kubectl get pods -n devops-demo -l app=devops-demo -o jsonpath='{.items[*].status.conditions[?(@.type=="Ready")].status}' | grep -o "True" | wc -l)
          TOTAL_PODS=$(kubectl get pods -n devops-demo -l app=devops-demo --no-headers | wc -l)

          echo "Ready pods: $READY_PODS / $TOTAL_PODS"

          if [ "$READY_PODS" -eq 0 ]; then
            echo "âŒ No pods are ready"
            echo "ğŸ“‹ Pod logs:"
            kubectl logs -n devops-demo -l app=devops-demo --tail=50
            exit 1
          fi

          echo "âœ… Deployment is healthy!"

      - name: Display deployment info
        if: success()
        run: |
          echo "âœ… =================================="
          echo "âœ… Deployment Summary"
          echo "âœ… =================================="
          echo ""
          echo "ğŸ“¦ Namespace: devops-demo"
          echo "ğŸš€ Application: devops-demo"
          echo "ğŸ·ï¸  Image: ${{ secrets.DOCKERHUB_USERNAME }}/devops-demo:latest"
          echo ""
          echo "ğŸ“Š Resources:"
          kubectl get all -n devops-demo -l app=devops-demo
          echo ""
          echo "ğŸŒ Service endpoints:"
          kubectl get svc -n devops-demo
          echo ""
          echo "ğŸ’¡ To access the application:"
          echo "   kubectl port-forward -n devops-demo svc/devops-demo-service 8080:80"
          echo "   Then visit: http://localhost:8080"

      - name: Deployment failure cleanup
        if: failure()
        run: |
          echo "âŒ Deployment failed. Gathering diagnostic information..."
          echo ""
          echo "ğŸ“‹ Pod status:"
          kubectl get pods -n devops-demo
          echo ""
          echo "ğŸ“‹ Pod descriptions:"
          kubectl describe pods -n devops-demo -l app=devops-demo
          echo ""
          echo "ğŸ“‹ Recent events:"
          kubectl get events -n devops-demo --sort-by='.lastTimestamp' | tail -30
          echo ""
          echo "ğŸ“‹ Deployment status:"
          kubectl describe deployment devops-demo -n devops-demo

      - name: Rollback on failure
        if: failure()
        run: |
          echo "ğŸ”„ Attempting to rollback to previous version..."
          if kubectl rollout undo deployment/devops-demo -n devops-demo; then
            echo "âœ… Rollback initiated successfully"
            kubectl rollout status deployment/devops-demo -n devops-demo --timeout=3m
          else
            echo "âš ï¸  Rollback failed or no previous revision available"
          fi
